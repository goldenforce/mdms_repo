{
  "TYPE" : "Workflow",
  "version" : "1.1.0",
  "timeZone" : "Europe/Belgrade",
  "title" : "Workflow for Archive Consolidation",
  "orderPreparation" : {
    "parameters" : {
      "start_offset" : {
        "type" : "Number",
        "default" : "0"
      },
      "end_offset" : {
        "type" : "Number",
        "default" : "0"
      },
      "process_bbg" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "bbg_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/bbg_in/done\""
      },
      "process_dss" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "dss_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/dss_in/done\""
      },
      "process_razor" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "razor_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/razor_in/done\""
      },
      "process_trep" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "trep_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/trep_in/done\""
      },
      "process_summit_in_g11_scaled" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "summit_in_scaled_g11_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/summit_in/g11/scaled/done\""
      },
      "process_summit_in_other_scaled" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "summit_in_scaled_other_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/sftpuser/pub/interfaces/summit_in/other/scaled/done\""
      },
      "process_murex_in" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "murex_in_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/murex/pub/interfaces/murex_in/done\""
      },
      "process_summit_in_other" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "summit_in_other_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/mdrp_summit/pub/interfaces/summit_in/other/done\""
      },
      "process_summit_in_g11" : {
        "type" : "Boolean",
        "default" : "true"
      },
      "summit_in_g11_done" : {
        "type" : "String",
        "default" : "\"/edmfs/transfers/mdrp_summit/pub/interfaces/summit_in/g11/done\""
      }
    },
    "allowUndeclared" : false
  },
  "instructions" : [ {
    "TYPE" : "Try",
    "try" : {
      "instructions" : [ {
        "TYPE" : "Execute.Named",
        "jobName" : "Operations_Consolidate_Archives",
        "label" : "Operations_Consolidate_Archive"
      } ]
    },
    "catch" : {
      "instructions" : [ {
        "TYPE" : "Finish",
        "message" : "Archives Consolidation failed",
        "unsuccessful" : true
      } ]
    }
  } ],
  "jobs" : {
    "Operations_Consolidate_Archives" : {
      "agentName" : "JSAgent",
      "withSubagentClusterIdExpr" : false,
      "executable" : {
        "TYPE" : "ShellScriptExecutable",
        "script" : "echo \" \"\necho \"=================================================================================================\"\necho \"Archives Consolidation\"\necho \"=================================================================================================\"\n\nconsolidate_archive()\n{\n\t# Get the folder path from argument\n    curr_date=\"$1\"\n    done_path=\"$2\"\n    \n    curr_yr=${curr_date:0:4}\n    curr_mnt=${curr_date:4:2}\n   \n    echo \"Processing date: ${curr_date}\"\n    echo \"Done path: ${done_path}\"\n\n    echo \"-------------------------------------------------------------------------------------------------\"\n    echo \" \"\n\n    echo \"CHECKS:\"\n\n    echo \" \"\n    echo \"-------------------------------------------------------------------------------------------------\"\n     \n    #ensure that done folder exists\n    echo \"-> Checking if done folder [ ${done_path} ] exists.\"\n    \n    if [ ! -d ${done_path} ]; then\n        echo \"++ -> Folder [ ${done_path} ] doesn't exist! Exiting...\"\n        exit 1\n    fi\n    \n    FILE=$(find \"${done_path}\" -maxdepth 1 -type f -iname  \"*${curr_date}*.*\" -print -quit)\n    \n\tif [ -n \"$FILE\" ]; then\n\n        echo \"-> Checking backup folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] for the current date.\"\n        \n        #create backup subfolder for the current date\n        if [ ! -d \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" ]; then\n            echo \"++ -> Folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] doesn't exist. Creating... it\"\n            mkdir -p \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\"\n            echo \"-> Checking again...\"\n            if [ ! -d \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" ]; then\n                echo \"++ -> Folder not found: ${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\"\n                exit 1\n            fi\n        else\n                echo \"++ -> Folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] exists.\"\n        fi\n    \n        if find \"${done_path}\" -maxdepth 1 -type f -iname  \"*${curr_date}*.*\" -exec mv -v {} \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" \\; ; then\n            echo \"-------------------------------------------------------------------------------------------------\"\n            echo \" \"\n            echo \"MOVING:\"\n            echo \" \"\n            echo \"-------------------------------------------------------------------------------------------------\"\n            echo \"-> Files moved to [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ]\"\n        else\n            echo \"-> File moving to [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] failed.\"\n            exit 1\n        fi\n    else\n    \techo \"-> No files for the current date. Skipping...\"\n    fi\n\n\n}\n\nconsolidate_archive_dash()\n{\n\t# Get the folder path from argument\n    curr_date=\"$1\"\n    done_path=\"$2\"\n    \n    curr_yr=${curr_date:0:4}\n    curr_mnt=${curr_date:4:2}\n\tcurr_day=${curr_date:6:2}\n   \n    echo \"Processing date: ${curr_date}\"\n    echo \"Done path: ${done_path}\"\n\tsearch_date=\"${curr_yr}-${curr_mnt}-${curr_day}\"\n\techo \"Search date: ${search_date}\"\n\n    echo \"-------------------------------------------------------------------------------------------------\"\n    echo \" \"\n\n    echo \"CHECKS:\"\n\n    echo \" \"\n    echo \"-------------------------------------------------------------------------------------------------\"\n     \n    #ensure that done folder exists\n    echo \"-> Checking if done folder [ ${done_path} ] exists.\"\n    \n    if [ ! -d ${done_path} ]; then\n        echo \"++ -> Folder [ ${done_path} ] doesn't exist! Exiting...\"\n        exit 1\n    fi\n    \n    FILE=$(find \"${done_path}\" -maxdepth 1 -type f -iname  \"*${search_date}*.*\" -print -quit)\n    \n\tif [ -n \"$FILE\" ]; then\n\n        echo \"-> Checking backup folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] for the current date.\"\n        \n        #create backup subfolder for the current date\n        if [ ! -d \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" ]; then\n            echo \"++ -> Folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] doesn't exist. Creating... it\"\n            mkdir -p \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\"\n            echo \"-> Checking again...\"\n            if [ ! -d \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" ]; then\n                echo \"++ -> Folder not found: ${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\"\n                exit 1\n            fi\n        else\n                echo \"++ -> Folder [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] exists.\"\n        fi\n    \n        if find \"${done_path}\" -maxdepth 1 -type f -iname  \"*${search_date}*.*\" -exec mv -v {} \"${done_path}/${curr_yr}/${curr_mnt}/${curr_date}\" \\; ; then\n            echo \"-------------------------------------------------------------------------------------------------\"\n            echo \" \"\n            echo \"MOVING:\"\n            echo \" \"\n            echo \"-------------------------------------------------------------------------------------------------\"\n            echo \"-> Files moved to [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ]\"\n        else\n            echo \"-> File moving to [ ${done_path}/${curr_yr}/${curr_mnt}/${curr_date} ] failed.\"\n            exit 1\n        fi\n    else\n    \techo \"-> No files for the current date. Skipping...\"\n    fi\n\n\n}\n\nconsolidate_bbg_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate BBG DL Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_dss_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate DSS Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_razor_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Razor Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_trep_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Trep Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_summit_in_g11_scaled_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Summit In G11 Scaled Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_summit_in_other_scaled_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Summit In Other Scaled Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_summit_in_g11_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Summit In G11 Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_summit_in_other_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Summit In Other Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nconsolidate_murex_in_arhive() {\n    date=$1\n    done_folder=$2\n    echo \" \"\n    echo \"=================================================================================================\"\n    echo \"Consolidate Murex In Archive\"\n    echo \"=================================================================================================\"\n    \n    consolidate_archive_dash ${date} ${done_folder}\n    \n    echo \"=================================================================================================\"\n}\n\nfor ((i=$start_offset; i>=$end_offset; --i)); do \n\toffset=\"-$i\"\n\toffset_day=\"${i} day ago\"\n\td=$(date --date=\"${offset_day}\" +%Y%m%d)\n\techo $offset_day\n    echo $d\n    \n    if [[ $(date --date=${d} +%u) -gt 5 ]]; then \n    \techo \"weekend\"; \n        continue;\n    fi\n    \n\tif $process_bbg; then\n\t\t#Consolidate BBG DL Archive\n        echo \"Consolidate BBG DL Archive for $d\"\n\t\tconsolidate_bbg_arhive $d $bbg_done\n\tfi\n    \n\tif $process_dss; then\n\t\t#Consolidate DSS Archive\n        echo \"Calling the function to Consolidate DSS Archive for $d\"\n\t\tconsolidate_dss_arhive $d $dss_done\n\tfi\n    \n\tif $process_razor; then\n\t\t#Consolidate Razor Archive\n        echo \"Calling the function to Consolidate Razor Archive for $d\"\n\t\tconsolidate_razor_arhive $d $razor_done\n\tfi\n    \n    \n\tif $process_trep; then\n\t\t#Consolidate Trep Archive\n        echo \"Calling the function to Consolidate Trep Archive for $d\"\n\t\tconsolidate_trep_arhive $d $trep_done\n\tfi\n    \n\tif $process_summit_in_g11_scaled; then\n\t\t#Consolidate Summit In G11 Scaled Archive\n        echo \"Calling the function to Consolidate Summit In G11 Scaled Archive for $d\"\n\t\tconsolidate_summit_in_g11_scaled_arhive $d $summit_in_scaled_g11_done\n\tfi\n    \n\tif $process_summit_in_other_scaled; then\n\t\t#Consolidate Summit In Other Scaled Archive\n        echo \"Calling the function to Consolidate Summit In Other Scaled Archive for $d\"\n\t\tconsolidate_summit_in_other_scaled_arhive $d $summit_in_scaled_other_done\n\tfi\n\n\tif $process_summit_in_g11; then\n\t\t#Consolidate Summit In G11 Archive\n        echo \"Calling the function to Consolidate Summit In G11 Archive for $d\"\n\t\tconsolidate_summit_in_g11_arhive $d $summit_in_g11_done\n\tfi\n    \n\tif $process_summit_in_other; then\n\t\t#Consolidate Summit In Other Archive\n        echo \"Calling the function to Consolidate Summit In Other Archive for $d\"\n\t\tconsolidate_summit_in_other_arhive $d $summit_in_other_done\n\tfi\n    \n\tif $process_murex_in; then\n\t\t#Consolidate Murex In Archive\n        echo \"Calling the function to Consolidate Murex In Archive for $d\"\n\t\tconsolidate_murex_in_arhive $d $murex_in_done\n\tfi\n    \ndone",
        "env" : {
          "start_offset" : "$start_offset",
          "end_offset" : "$end_offset",
          "process_bbg" : "$process_bbg",
          "bbg_done" : "$bbg_done",
          "process_dss" : "$process_dss",
          "dss_done" : "$dss_done",
          "process_razor" : "$process_razor",
          "razor_done" : "$razor_done",
          "process_trep" : "$process_trep",
          "trep_done" : "$trep_done",
          "process_summit_in_g11_scaled" : "$process_summit_in_g11_scaled",
          "summit_in_scaled_g11_done" : "$summit_in_scaled_g11_done",
          "process_summit_in_other_scaled" : "$process_summit_in_other_scaled",
          "summit_in_scaled_other_done" : "$summit_in_scaled_other_done",
          "process_summit_in_g11" : "$process_summit_in_g11",
          "summit_in_g11_done" : "$summit_in_g11_done",
          "process_summit_in_other" : "$process_summit_in_other",
          "summit_in_other_done" : "$summit_in_other_done",
          "process_murex_in" : "$process_murex_in",
          "murex_in_done" : "$murex_in_done"
        },
        "v1Compatible" : false
      },
      "skipIfNoAdmissionForOrderDay" : false,
      "parallelism" : 1,
      "graceTimeout" : 15,
      "failOnErrWritten" : false,
      "warnOnErrWritten" : false,
      "jobResourceNames" : [ "C_JR_Common" ],
      "title" : "Operations_Consolidate_Archives",
      "notification" : {
        "types" : [ "ERROR", "WARNING" ],
        "mail" : {
          "to" : "mdrplussupport@commerzbank.com",
          "cc" : "afa55d54.Commerzbank.onmicrosoft.com@emea.teams.ms"
        }
      }
    }
  }
}